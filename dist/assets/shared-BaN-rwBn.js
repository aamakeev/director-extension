(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();const S=e=>!!e&&typeof e=="object"&&"protocol"in e&&e.protocol==="iframe_pubsub"&&"version"in e&&e.version==="1.0",M=(e,t)=>e,v="0123456789ABCDEFGHJKMNPQRSTVWXYZ";var d;(function(e){e.Base32IncorrectEncoding="B32_ENC_INVALID",e.DecodeTimeInvalidCharacter="DEC_TIME_CHAR",e.DecodeTimeValueMalformed="DEC_TIME_MALFORMED",e.EncodeTimeNegative="ENC_TIME_NEG",e.EncodeTimeSizeExceeded="ENC_TIME_SIZE_EXCEED",e.EncodeTimeValueMalformed="ENC_TIME_MALFORMED",e.PRNGDetectFailure="PRNG_DETECT",e.ULIDInvalid="ULID_INVALID",e.Unexpected="UNEXPECTED",e.UUIDInvalid="UUID_INVALID"})(d||(d={}));class m extends Error{constructor(t,r){super(`${r} (${t})`),this.name="ULIDError",this.code=t}}function y(e){const t=Math.floor(e()*32)%32;return v.charAt(t)}function _(e){const t=I(),r=t&&(t.crypto||t.msCrypto)||null;if(typeof(r==null?void 0:r.getRandomValues)=="function")return()=>{const s=new Uint8Array(1);return r.getRandomValues(s),s[0]/255};if(typeof(r==null?void 0:r.randomBytes)=="function")return()=>r.randomBytes(1).readUInt8()/255;throw new m(d.PRNGDetectFailure,"Failed to find a reliable PRNG")}function I(){return T()?self:typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:null}function R(e,t){let r="";for(;e>0;e--)r=y(t)+r;return r}function N(e,t=10){if(isNaN(e))throw new m(d.EncodeTimeValueMalformed,`Time must be a number: ${e}`);if(e>0xffffffffffff)throw new m(d.EncodeTimeSizeExceeded,`Cannot encode a time larger than ${0xffffffffffff}: ${e}`);if(e<0)throw new m(d.EncodeTimeNegative,`Time must be positive: ${e}`);if(Number.isInteger(e)===!1)throw new m(d.EncodeTimeValueMalformed,`Time must be an integer: ${e}`);let r,s="";for(let n=t;n>0;n--)r=e%32,s=v.charAt(r)+s,e=(e-r)/32;return s}function T(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}function f(e,t){const r=_(),s=Date.now();return N(s,10)+R(16,r)}const C=({seq:e,uniqId:t})=>r=>({protocol:"iframe_pubsub",version:"1.0",id:t(),seq:e(),timestamp:Date.now(),...r}),E=C({uniqId:()=>f(),seq:()=>f()});class D{constructor(t){this.eventHandlerMap=new Map,this.globalMessageHandler=(n,o)=>{if(S(n)){if(n.type==="event"){const{eventName:i}=n,a=this.eventHandlerMap.get(i);if(!a)return;a.forEach(c=>{try{c(n.data,o.id)}catch(g){console.error("[PubSubSubscriber] globalMessageHandler: failed to handle income message",g)}});return}console.error("[PubSubSubscriber] globalMessageHandler: unhandled message",n)}};const{brokerId:r,transport:s}=t;this.brokerId=r,this.transport=s,this.transport.onMessage(this.globalMessageHandler)}subscribe(t,r){const s=M(t);let n=this.eventHandlerMap.get(s);n||(n=new Set,this.eventHandlerMap.set(s,n)),n.add(r);const o=E({type:"subscribe",eventName:t});this.transport.send(this.brokerId,o)}unsubscribe(t,r){const s=M(t);let n=this.eventHandlerMap.get(s);if(!n)return;r?n.delete(r):this.eventHandlerMap.delete(s);const o=E({type:"unsubscribe",eventName:t});this.transport.send(this.brokerId,o)}}const k=!!Error.captureStackTrace,A="APP_ERROR";class p extends Error{constructor(t,r){super(t),this.name=new.target.name||A,this.cause=r,k&&Error.captureStackTrace(this,this.constructor)}static getChainedMessage(t){let{message:r}=t;return t instanceof p&&t.cause&&(r+=`
Caused by: ${p.getChainedMessage(t.cause)}`),r}toJSON(){return{name:this.name,message:this.message,cause:this.cause?p.getChainedMessage(this.cause):void 0}}}const P={INTERNAL_ERROR:"INTERNAL_ERROR"},O="RPC_ERROR";class L extends p{constructor(t){super(t.message||"unknown rpc error"),this.name=O,this.code=(t==null?void 0:t.code)||P.INTERNAL_ERROR}}const $=e=>!!e&&typeof e=="object"&&"protocol"in e&&e.protocol==="iframe_rpc"&&"version"in e&&e.version==="1.0",H=({uniqId:e})=>t=>({protocol:"iframe_rpc",version:"1.0",id:e(),timestamp:Date.now(),...t}),U=H({uniqId:()=>f()});class q{constructor(t){this.pendingEntryMap=new Map,this.globalMessageHandler=n=>{if($(n)){if(n.type==="response"&&n.status==="ok"){const o=n.id,i=this.pendingEntryMap.get(o);if(!i){console.error("[RpcClient] globalMessageHandler: got success response without pending request",n);return}this.pendingEntryMap.delete(o),i.resolve(n.result);return}if(n.type==="response"&&n.status==="error"){const o=n.id,i=this.pendingEntryMap.get(o);if(!i){console.error("[RpcClient] globalMessageHandler: got error response without pending request",n);return}this.pendingEntryMap.delete(o),i.reject(new L(n.error));return}console.error("[RpcClient] globalMessageHandler: invalid message schema",n)}};const{serverId:r,transport:s}=t;this.serverId=r,this.transport=s,this.transport.onMessage(this.globalMessageHandler)}makeRequest(t,r){const s=U({type:"request",method:t,params:r}),n=new Promise((o,i)=>{this.pendingEntryMap.set(s.id,{method:t,resolve:a=>{o(a)},reject:a=>{i(a)}})});try{this.transport.send(this.serverId,s)}catch(o){console.error("[RpcClient] makeRequest: failed to send rpc message",o);const i=this.pendingEntryMap.get(s.id);i&&(this.pendingEntryMap.delete(s.id),i.reject(o))}return n}}class G{constructor(t){this.peers=new Map,this.onMessage=s=>{const n=o=>{const{data:i,origin:a,source:c}=o;if(!c){console.error("[PostMessageTransport] onMessage: source could not be empty");return}const g=this.findPeer(c,a);if(g)try{s(i,g)}catch(w){console.error("[PostMessageTransport] onMessage: failed to call cb on message",w)}};return this.localWindow.addEventListener("message",n),()=>{this.localWindow.removeEventListener("message",n)}};const{localWindow:r}=t;this.localWindow=r||window}send(t,r){const s=this.peers.get(t);s&&s.source.postMessage(r,s.origin)}broadcast(t){this.peers.forEach(r=>{r.source.postMessage(t,r.origin)})}broadcastGroup(t,r){t.forEach(s=>{this.send(s,r)})}addPeer(t){this.peers.set(t.id,t)}removePeer(t){this.peers.delete(t)}findPeer(t,r){for(const[s,n]of this.peers)if(n.source===t&&n.origin===r)return n;return null}}class z{constructor(t){const{serverId:r,serverOrigin:s,serverSource:n,theme:o}=t,i={id:r,origin:s,source:n},a=new G({});a.addPeer(i),this.rpcClient=new q({transport:a,serverId:r}),this.subscriber=new D({transport:a,brokerId:i.id}),document.documentElement.dataset.theme=o}makeRequest(t,r){return this.rpcClient.makeRequest(t,r)}subscribe(t,r){return this.subscriber.subscribe(t,r)}unsubscribe(t,r){return this.subscriber.unsubscribe(t,r)}bootstrap(){let t={height:0,width:0};const r=document.documentElement,s=(o,i)=>{(t.height!==i||t.width!==o)&&(t={height:i,width:o},this.makeRequest("v1.system.resize.notify",{height:i,width:o}))},n=o=>{for(const i of o){if(i.target!==r)continue;const{height:a,width:c}=i.contentRect;s(c,a)}};(()=>{const{height:o,width:i}=r.getBoundingClientRect();s(i,o)})(),new ResizeObserver(n).observe(document.documentElement)}}const V=()=>{const e=new URL(window.location.href),t=e.searchParams.get("origin")||"",r=e.searchParams.get("theme")||"dark",s=new z({serverId:"server",serverOrigin:t||window.parent.origin,serverSource:window.parent,theme:r});return s.bootstrap(),s},F=[{id:"visual",title:"ВИЗУАЛ",commands:[{id:"visual_closeup",label:"Крупный план"},{id:"visual_angle",label:"Ракурс"},{id:"visual_eyes",label:"В глаза"}]},{id:"tempo",title:"ТЕМП",commands:[{id:"tempo_slow",label:"Медленно"},{id:"tempo_turbo",label:"Турбо"},{id:"tempo_freeze",label:"Замри"}]},{id:"sound",title:"ЗВУК",commands:[{id:"sound_whisper",label:"Шёпот"},{id:"sound_dirty_talk",label:"Dirty Talk"},{id:"sound_silence",label:"Тишина"}]},{id:"acting",title:"АКТЕРСТВО",commands:[{id:"acting_good",label:"Хорошая девочка"},{id:"acting_bad",label:"Плохая девочка"}]}],j=Object.fromEntries(F.flatMap(e=>e.commands.map(t=>[t.id,{...t,categoryId:e.id,categoryTitle:e.title}]))),l={preproductionGoal:50,overtakeMargin:10,minTenureSec:15,commandDurationSec:20,commandCooldownSec:6,tipMenuRefreshSec:20,fallbackTipMenu:`Крупный план|25
Танец|40
В глаза|30`,backendUrl:"",backendApiKey:""},u=(e,t,{min:r=0,max:s=Number.MAX_SAFE_INTEGER}={})=>{const n=Number(e);return!Number.isFinite(n)||n<r?t:n>s?s:Math.floor(n)},h=(e,t="")=>String(e??"").trim()||t,b=(e,t)=>String(e||"").toLowerCase().replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,"").slice(0,64)||t,W=(e={})=>({preproductionGoal:u(e.preproductionGoal,l.preproductionGoal,{min:10,max:1e4}),overtakeMargin:u(e.overtakeMargin,l.overtakeMargin,{min:1,max:1e3}),minTenureSec:u(e.minTenureSec,l.minTenureSec,{min:5,max:600}),commandDurationSec:u(e.commandDurationSec,l.commandDurationSec,{min:5,max:300}),commandCooldownSec:u(e.commandCooldownSec,l.commandCooldownSec,{min:1,max:120}),tipMenuRefreshSec:u(e.tipMenuRefreshSec,l.tipMenuRefreshSec,{min:5,max:300}),fallbackTipMenu:h(e.fallbackTipMenu,l.fallbackTipMenu),backendUrl:h(e.backendUrl,l.backendUrl),backendApiKey:h(e.backendApiKey,l.backendApiKey)}),x=e=>String(e||"").split(/\r?\n/g).map(t=>t.trim()).filter(Boolean).map((t,r)=>{const[s,n]=t.split("|").map(c=>c.trim()),o=String(s||"Позиция").slice(0,80),i=Number(n||0),a=Number.isFinite(i)?Math.max(1,Math.floor(i)):1;return{id:b(`${o}_${a}_${r}`,`fallback_${r}`),title:o,price:a}}).filter(t=>t.title&&t.price>0),B=(e,t)=>{const r=String((e==null?void 0:e.activity)||"").trim(),s=Math.max(0,Math.floor(Number((e==null?void 0:e.price)||0)));if(!r||!s)return null;const n=String((e==null?void 0:e.id)||"").trim();return{id:n?b(n,`tip_${t}`):b(`${r}_${s}_${t}`,`tip_${t}`),title:r,price:s}},K=(e,t)=>{var o,i;const s=(Array.isArray((o=e==null?void 0:e.tipMenu)==null?void 0:o.settings)?e.tipMenu.settings:[]).map((a,c)=>B(a,c)).filter(Boolean),n=s.length?s:x(t);return{isEnabled:n.length>0,settings:n,updatedAt:Number(((i=e==null?void 0:e.tipMenu)==null?void 0:i.updatedAt)||Date.now())}},X=e=>{const t=Math.max(0,Math.ceil(Number(e||0)/1e3)),r=Math.floor(t/60),s=t%60;return r?`${r}:${String(s).padStart(2,"0")}`:`${s}s`},Z=e=>!!e&&typeof e=="object"&&!Array.isArray(e),J=e=>String(e||"").trim().replace(/[^a-zA-Z0-9_-]/g,"").slice(0,64),Y=(e,t=0)=>{const r=Number(e);return!Number.isFinite(r)||r<0?t:r};export{F as C,l as D,K as a,j as b,Y as c,X as f,Z as i,W as n,V as q,J as s};
