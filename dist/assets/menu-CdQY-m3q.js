import{q as z,f as F,C as J}from"./shared-BaN-rwBn.js";const p=z(),i=e=>document.getElementById(e),w=i("role-label"),K=i("phase-pill"),g=i("live-indicator"),Q=i("session-tips"),W=i("director-name"),X=i("director-power"),Y=i("challenger-line"),S=i("pressure-track"),ee=i("pressure-fill"),I=i("pressure-text"),te=i("tenure-text"),ne=i("director-console"),R=i("console-groups"),k=i("goals-list"),oe=i("tip-controls"),H=i("selected-goal-label"),se=i("tip-amount"),M=i("tip-button"),v=i("self-allocations"),E=i("realloc-from"),f=i("realloc-to"),le=i("realloc-amount"),U=i("realloc-button"),P=i("current-performance"),b=i("queue-list"),y=i("command-history"),L=i("activity-feed"),ie=i("toast-stack");let h={user:null,model:null},n=null,d="",A=[],O=0,q=!1;const m=()=>{var e;return String(((e=h.user)==null?void 0:e.id)||"")},B=()=>{var e;return String(((e=h.user)==null?void 0:e.username)||"viewer")},C=()=>{var e;return!!((e=h.user)!=null&&e.isModel)},G=()=>{var e;return!!((e=n==null?void 0:n.director)!=null&&e.id&&n.director.id===m())},a=e=>{const t=document.createElement("div");t.className="toast",t.textContent=String(e||"").slice(0,180),ie.appendChild(t),setTimeout(()=>t.remove(),3500)},$=e=>{if(!e||typeof e!="object")return!1;const t=String(e.targetUserId||""),o=m();return!!(t&&o&&t===o)},ce=async()=>{await p.makeRequest("v1.ext.whisper",{data:{type:"director.state.request"}})},re=async()=>{m()&&await p.makeRequest("v1.ext.whisper",{data:{type:"director.self.allocations.request",userId:m()}})},ae=()=>{const e={};return((n==null?void 0:n.menuGoals)||[]).forEach(t=>{e[t.id]=t}),e},de=()=>{if(!n)return;const e=C(),t=G();e?w.textContent="Роль: модель":t?w.textContent="Роль: режиссёр":w.textContent="Роль: зритель",ne.classList.toggle("hidden",!t||!n.isLive),oe.classList.toggle("hidden",e)},me=()=>{var c,l,s;const e=(n==null?void 0:n.pressure)||{},t=Math.max(0,Math.min(100,Number(e.percent||0)));ee.style.width=`${t}%`;const o=!!(e.isCritical&&((c=n==null?void 0:n.challenger)!=null&&c.id));if(S.classList.toggle("is-critical",o),!((l=n==null?void 0:n.director)!=null&&l.id)||!((s=n==null?void 0:n.challenger)!=null&&s.id)){I.textContent="Ожидаем претендента";return}if(o){I.textContent=`Критично: разрыв < ${n.overtakeMargin} тк`;return}I.textContent=`До перехвата нужно: ${e.neededToOvertake} тк`},ue=()=>{const e=n;if(!e)return;const t=G(),o=e.commandCooldowns||{};R.innerHTML="",J.forEach(c=>{const l=document.createElement("div");l.className="group";const s=document.createElement("div");s.className="group-title",s.textContent=c.title;const r=document.createElement("div");r.className="buttons",c.commands.forEach(x=>{const u=document.createElement("button");u.type="button",u.className="cmd-btn";const _=Math.max(0,Number(o[x.id]||0)),N=Math.ceil(_/1e3);u.textContent=N>0?`${x.label} (${N}с)`:x.label,u.disabled=!t||!e.isLive||N>0,u.addEventListener("click",async()=>{if(!G()){a("Пульт доступен только текущему Режиссёру");return}u.classList.add("is-pressed"),setTimeout(()=>u.classList.remove("is-pressed"),220),await p.makeRequest("v1.ext.whisper",{data:{type:"director.command.issue",userId:m(),username:B(),commandId:x.id}})}),r.appendChild(u)}),l.appendChild(s),l.appendChild(r),R.appendChild(l)})},j=()=>{const e=(n==null?void 0:n.menuGoals)||[];if(!e.length){d="",H.textContent="Позиции tip menu пока не доступны.";return}const t=e.find(o=>o.id===d)||e[0];d=t.id,H.textContent=`Выбрано: «${t.title}»`},D=()=>{const e=(n==null?void 0:n.menuGoals)||[];if(k.innerHTML="",!e.length){const t=document.createElement("div");t.className="small",t.textContent="Tip menu пуст. Проверьте настройки модели.",k.appendChild(t);return}e.some(t=>t.id===d)||(d=e[0].id),e.forEach(t=>{const o=document.createElement("div");o.className=`goal-card${t.id===d?" is-selected":""}`;const c=document.createElement("div");c.className="goal-name",c.textContent=t.title;const l=document.createElement("div");l.className="goal-meta",l.textContent=`${t.progress}/${t.price} тк · осталось ${t.tokensLeft}`;const s=document.createElement("div");s.className="goal-progress";const r=document.createElement("span");r.style.width=`${Math.max(0,Math.min(100,Number(t.percent||0)))}%`,s.appendChild(r),o.appendChild(c),o.appendChild(l),o.appendChild(s),o.addEventListener("click",()=>{d=t.id,D(),j(),T()}),k.appendChild(o)})},V=()=>{const e=Object.fromEntries(A.map(l=>[l.itemId,l.allocated])),t=(n==null?void 0:n.menuGoals)||[];v.innerHTML="";const o=t.map(l=>({title:l.title,amount:Math.max(0,Number(e[l.id]||0))})).filter(l=>l.amount>0);if(o.length)o.forEach(l=>{const s=document.createElement("li");s.textContent=`${l.title}: ${l.amount} тк`,v.appendChild(s)});else{const l=document.createElement("li");l.textContent="Пока нет распределенных токенов",v.appendChild(l)}const c=document.createElement("li");c.textContent=`Всего внесено за сессию: ${O} тк`,c.style.color="#ffcb66",v.appendChild(c)},T=()=>{var l;const e=(n==null?void 0:n.menuGoals)||[],t=Object.fromEntries(A.map(s=>[s.itemId,s.allocated])),o=e.filter(s=>Number(t[s.id]||0)>0);if(E.innerHTML="",f.innerHTML="",o.forEach(s=>{const r=document.createElement("option");r.value=s.id,r.textContent=`${s.title} (${t[s.id]} тк)`,E.appendChild(r)}),!o.length){const s=document.createElement("option");s.value="",s.textContent="Нет источника",E.appendChild(s)}const c=E.value||((l=o[0])==null?void 0:l.id)||"";if(e.filter(s=>s.id!==c).forEach(s=>{const r=document.createElement("option");r.value=s.id,r.textContent=s.title,f.appendChild(r)}),!f.options.length){const s=document.createElement("option");s.value="",s.textContent="Нет цели",f.appendChild(s)}U.disabled=!o.length||!f.value||C()},pe=()=>{const e=n==null?void 0:n.currentPerformance;if(e?P.textContent=`Сейчас: ${e.categoryTitle} / ${e.label} (${F(e.remainingMs)})`:P.textContent="Сейчас: ожидание",b.innerHTML="",((n==null?void 0:n.queue)||[]).slice(0,6).forEach(t=>{const o=document.createElement("li");o.textContent=`${t.categoryTitle}: ${t.label} (${t.issuedByName})`,b.appendChild(o)}),!b.childElementCount){const t=document.createElement("li");t.textContent="Очередь пуста",b.appendChild(t)}if(y.innerHTML="",((n==null?void 0:n.commandHistory)||[]).slice(0,6).forEach(t=>{const o=document.createElement("li");o.textContent=`${t.categoryTitle}: ${t.label} (${t.issuedByName})`,y.appendChild(o)}),!y.childElementCount){const t=document.createElement("li");t.textContent="Пока нет команд",y.appendChild(t)}},fe=()=>{if(L.innerHTML="",((n==null?void 0:n.activityFeed)||[]).slice(0,8).forEach(e=>{const t=document.createElement("li");t.textContent=e.text,L.appendChild(t)}),!L.childElementCount){const e=document.createElement("li");e.textContent="Активность появится после первых действий",L.appendChild(e)}},Ee=()=>{var t,o,c,l;if(!n)return;K.textContent=n.isLive?"LIVE":"ПРЕДПРОДАКШН",Q.textContent=`${n.totalSessionTips} / ${n.preproductionGoal} тк`,n.isLive?(g.style.opacity="1",g.lastElementChild.textContent="LIVE"):(g.style.opacity="0.65",g.lastElementChild.textContent="PRE"),W.textContent=`Режиссёр: ${((t=n.director)==null?void 0:t.name)||"Casting..."}`,X.textContent=`Сила: ${((o=n.director)==null?void 0:o.total)||0} тк`,Y.textContent=`Претендент: ${((c=n.challenger)==null?void 0:c.name)||"None"} (${((l=n.challenger)==null?void 0:l.total)||0} тк)`,me();const e=Math.max(0,Number(n.directorTenureLeftMs||0));te.textContent=e?`Иммунитет режиссёра: ${F(e)}`:"Иммунитет не активен"},Z=()=>{n&&(de(),Ee(),ue(),D(),j(),V(),T(),pe(),fe(),M.disabled=C()||!d||q)},he=async()=>{if(C()){a("Модель не отправляет типы из этого блока");return}if(!m()){a("Нужно войти в аккаунт");return}if(!d){a("Выберите позицию меню");return}const e=Math.max(0,Math.floor(Number(se.value||0)));if(!e){a("Сумма должна быть больше 0");return}if(!ae()[d]){a("Позиция недоступна");return}q=!0,M.disabled=!0;try{await p.makeRequest("v1.payment.tokens.spend",{tokensAmount:e,tokensSpendData:{action:"director.menu.tip",userId:m(),username:B(),itemId:d}})}catch{a("Ошибка платежа")}finally{q=!1,M.disabled=!1}},Ce=async()=>{if(C()){a("Для модели перераспределение отключено");return}if(!m()){a("Нужно войти в аккаунт");return}const e=String(E.value||"").trim(),t=String(f.value||"").trim(),o=Math.max(0,Math.floor(Number(le.value||0)));if(!e||!t||e===t){a("Выберите корректные from/to");return}if(!o){a("Сумма должна быть больше 0");return}await p.makeRequest("v1.ext.whisper",{data:{type:"director.menu.reallocate",userId:m(),username:B(),fromItemId:e,toItemId:t,amount:o}})};M.addEventListener("click",()=>{he()});E.addEventListener("change",()=>{T()});U.addEventListener("click",()=>{Ce()});p.subscribe("v1.ext.whispered",e=>{if(!(!e||typeof e!="object")){if(e.type==="director.state"){n=e,Z();return}if($(e)&&e.type==="director.self.allocations"){A=Array.isArray(e.allocations)?e.allocations:[],O=Math.max(0,Number(e.total||0)),V(),T();return}if($(e)&&e.type==="director.command.result"){a(e.message||"Команда обработана");return}if($(e)&&e.type==="director.menu.reallocate.result"){a(e.message||"Перераспределение обработано");return}$(e)&&e.type==="director.menu.tip.result"&&a(e.message||"Вклад обработан")}});p.subscribe("v1.ext.context.updated",e=>{!e||typeof e!="object"||(h=e.context||h,Z())});const xe=async()=>{h=await p.makeRequest("v1.ext.context.get",null),await ce(),await re()};xe();
