import{q as ae,n as J,D as V,a as _,i as d,c as l,b as W,s as se}from"./shared-BaN-rwBn.js";const y=ae(),Y="directorMvpState_v2",Q="/api/sessions",ie=5e3,ce=15e3,le=7e3,ue=1e3;let q={user:null,model:null},c=J(V);const w=()=>({isLive:!1,totalSessionTips:0,director:{id:null,name:"Casting...",total:0,startTime:0},challenger:{id:null,name:"None",total:0},users:{},tipMenu:{isEnabled:!1,settings:[],updatedAt:0,source:"fallback"},menuGoals:[],currentPerformance:null,queue:[],commandHistory:[],commandCooldowns:{},overlayFlashAt:0,activityFeed:[],savedAt:Date.now()});let n=w(),U=null,A=null,T=null,H=null,G=Promise.resolve(),x=!1;const g=(e,t=0)=>{const o=Number(e);return Number.isFinite(o)?o:t},$=e=>Math.max(0,Math.floor(l(e==null?void 0:e.savedAt,0))),O=()=>{var e;return se((e=q.model)==null?void 0:e.id)},X=()=>String(c.backendUrl||"").trim().replace(/\/+$/,""),de=()=>String(c.backendApiKey||"").trim(),b=()=>!!(X()&&O()),S=e=>{n.activityFeed.unshift({id:`a_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,at:Date.now(),text:String(e||"").slice(0,180)}),n.activityFeed=n.activityFeed.slice(0,30)},me=(e,t)=>{const o=String(e||"").trim();return o?{id:o,name:String(t||"viewer").slice(0,60)}:null},Z=(e,t)=>{const o=me(e,t);if(!o)return null;n.users[o.id]||(n.users[o.id]={id:o.id,name:o.name,total:0,allocations:{}});const r=n.users[o.id];return r.name=o.name,d(r.allocations)||(r.allocations={}),r},B=()=>Object.values(n.users).sort((e,t)=>t.total-e.total),K=e=>{const t=e.find(o=>o.id!==n.director.id);if(!t){n.challenger={id:null,name:"None",total:0};return}n.challenger={id:t.id,name:t.name,total:t.total}},C=e=>{e&&y.makeRequest("v1.chat.message.send",{message:e,isAnonymous:!1,user:q.user??null}).catch(()=>null)},E=(e,t)=>{if(n.director={id:e.id,name:e.name,total:e.total,startTime:Date.now()},n.overlayFlashAt=Date.now(),t==="liveStart"){S(`ЭФИР стартовал. Новый режиссёр: ${e.name}`),C(`РЕЖИССЁР LIVE: старт! Режиссёр — ${e.name}.`);return}if(t==="overtake"){S(`Смена власти: ${e.name} перехватил пульт`),C(`Смена режиссёра: теперь командует ${e.name}.`);return}S(`Режиссёр: ${e.name}`)},k=({triggerUserId:e=""}={})=>{const t=B();if(!n.isLive&&n.totalSessionTips>=c.preproductionGoal&&t.length){n.isLive=!0;const a=e?n.users[e]:null;E(a||t[0],"liveStart")}if(!n.isLive){K(t);return}if(!t.length){n.director={id:null,name:"Casting...",total:0,startTime:0},n.challenger={id:null,name:"None",total:0};return}const o=n.director.id?n.users[n.director.id]:null;o?(n.director.name=o.name,n.director.total=o.total):E(t[0],"fallback");const r=B().find(a=>a.id!==n.director.id)||null;if(r){const a=Date.now()-n.director.startTime>=c.minTenureSec*1e3,s=r.total>=n.director.total+c.overtakeMargin;a&&s&&E(r,"overtake")}K(B())},z=e=>(e||[]).map(t=>`${t.id}:${t.title}:${t.price}`).join("|"),fe=()=>{var o;const e=new Set(n.tipMenu.settings.map(r=>r.id)),t=((o=n.tipMenu.settings[0])==null?void 0:o.id)||"";Object.values(n.users).forEach(r=>{const a=d(r.allocations)?r.allocations:{},s={};let u=0;Object.entries(a).forEach(([m,i])=>{const p=Math.max(0,Math.floor(g(i,0)));if(p){if(e.has(m)){s[m]=(s[m]||0)+p;return}u+=p}}),u>0&&t&&(s[t]=(s[t]||0)+u),r.allocations=s})},v=()=>{const e={},t=new Set(n.tipMenu.settings.map(o=>o.id));Object.values(n.users).forEach(o=>{Object.entries(o.allocations||{}).forEach(([r,a])=>{if(!t.has(r))return;const s=Math.max(0,Math.floor(g(a,0)));s&&(e[r]=(e[r]||0)+s)})}),n.menuGoals=n.tipMenu.settings.map(o=>{const r=e[o.id]||0,a=Math.max(0,o.price-r),s=o.price>0?Math.min(100,r/o.price*100):0;return{id:o.id,title:o.title,price:o.price,progress:r,tokensLeft:a,percent:s}}).sort((o,r)=>o.tokensLeft!==r.tokensLeft?o.tokensLeft-r.tokensLeft:o.price!==r.price?o.price-r.price:o.title.localeCompare(r.title))},P=(e,t="sdk")=>{const o=z(n.tipMenu.settings);n.tipMenu={isEnabled:!!(e!=null&&e.isEnabled),settings:Array.isArray(e==null?void 0:e.settings)?e.settings:[],updatedAt:Number((e==null?void 0:e.updatedAt)||Date.now()),source:t},fe(),v();const r=z(n.tipMenu.settings);return r!==o&&r&&S("Tip menu обновлено"),r!==o},F=async()=>{try{const e=await y.makeRequest("v1.model.tip.menu.get",null),t=_(e,c.fallbackTipMenu);return P(t,"sdk")}catch{if(!n.tipMenu.settings.length){const e=_(null,c.fallbackTipMenu);return P(e,"fallback")}return!1}},N=e=>n.tipMenu.settings.find(t=>t.id===e)||null,ge=()=>n.tipMenu.settings[0]||null,he=()=>{const e=Math.max(0,g(n.director.total,0)),t=Math.max(0,g(n.challenger.total,0)),o=Math.max(0,e-t),r=e+c.overtakeMargin,a=r>0?Math.min(100,t/r*100):0;return{gap:o,margin:c.overtakeMargin,neededToOvertake:Math.max(0,r-t),percent:a,isCritical:o<c.overtakeMargin}},pe=()=>{const e=Date.now();return Object.keys(W).reduce((t,o)=>{const r=Number(n.commandCooldowns[o]||0);return!r||r<=e||(t[o]=r-e),t},{})},ye=()=>{const e=he(),t=Date.now(),o=n.director.startTime?Math.max(0,n.director.startTime+c.minTenureSec*1e3-t):0;return{type:"director.state",isLive:n.isLive,phaseLabel:n.isLive?"ЭФИР":"ПРЕДПРОДАКШН",totalSessionTips:n.totalSessionTips,preproductionGoal:c.preproductionGoal,overtakeMargin:c.overtakeMargin,minTenureSec:c.minTenureSec,director:n.director,challenger:n.challenger,pressure:e,directorTenureLeftMs:o,menuGoals:n.menuGoals,menuSource:n.tipMenu.source,currentPerformance:n.currentPerformance?{...n.currentPerformance,remainingMs:Math.max(0,n.currentPerformance.endsAt-t)}:null,queue:n.queue.map(r=>({id:r.id,commandId:r.commandId,label:r.label,categoryTitle:r.categoryTitle,issuedByName:r.issuedByName,issuedAt:r.issuedAt})),commandHistory:n.commandHistory,commandCooldowns:pe(),overlayFlashAt:n.overlayFlashAt,activityFeed:n.activityFeed.slice(0,20),updatedAt:t}},f=(e,t)=>{y.makeRequest("v1.ext.whisper",{data:{...t,targetUserId:String(e||"")}})},L=e=>{const t=String(e||"");if(!t)return;const o=n.users[t],r=n.menuGoals.map(a=>{var s;return{itemId:a.id,title:a.title,allocated:Math.max(0,Math.floor(g((s=o==null?void 0:o.allocations)==null?void 0:s[a.id],0)))}});f(t,{type:"director.self.allocations",total:Math.max(0,Math.floor(g(o==null?void 0:o.total,0))),allocations:r})},h=()=>{y.makeRequest("v1.ext.whisper",{data:ye()})},Se=()=>{x||(x=!0,y.makeRequest("v1.ext.overlay.open",{source:"extension"}).catch(()=>{x=!1}))},Me=e=>{if(typeof structuredClone=="function")try{return structuredClone(e)}catch{}try{return JSON.parse(JSON.stringify(e))}catch{return w()}},R=(e=Date.now())=>({savedAt:e,gameState:Me(n)}),D=(e={})=>{if(!d(e.gameState)){n=w();return}const t=e.gameState,o=d(t.users)?t.users:{};if(n=w(),n.isLive=!!t.isLive,n.totalSessionTips=Math.max(0,Math.floor(l(t.totalSessionTips,0))),d(t.director)&&(n.director={id:t.director.id?String(t.director.id):null,name:String(t.director.name||"Casting..."),total:Math.max(0,Math.floor(l(t.director.total,0))),startTime:Math.max(0,Math.floor(l(t.director.startTime,0)))}),d(t.challenger)&&(n.challenger={id:t.challenger.id?String(t.challenger.id):null,name:String(t.challenger.name||"None"),total:Math.max(0,Math.floor(l(t.challenger.total,0)))}),Object.entries(o).forEach(([r,a])=>{if(!d(a))return;const s=d(a.allocations)?a.allocations:{},u={};Object.entries(s).forEach(([m,i])=>{const p=Math.max(0,Math.floor(l(i,0)));p>0&&(u[m]=p)}),n.users[r]={id:r,name:String(a.name||"viewer").slice(0,60),total:Math.max(0,Math.floor(l(a.total,0))),allocations:u}}),d(t.tipMenu)){const r={isEnabled:!!t.tipMenu.isEnabled,settings:Array.isArray(t.tipMenu.settings)?t.tipMenu.settings.map(a=>{const s=String((a==null?void 0:a.id)||"").trim(),u=String((a==null?void 0:a.title)||"").trim(),m=Math.max(0,Math.floor(l(a==null?void 0:a.price,0)));return!s||!u||!m?null:{id:s,title:u,price:m}}).filter(Boolean):[],updatedAt:Math.max(0,Math.floor(l(t.tipMenu.updatedAt,0))),source:String(t.tipMenu.source||"fallback")};P(r,r.source)}n.currentPerformance=d(t.currentPerformance)?{id:String(t.currentPerformance.id||""),commandId:String(t.currentPerformance.commandId||""),label:String(t.currentPerformance.label||""),categoryTitle:String(t.currentPerformance.categoryTitle||""),issuedByName:String(t.currentPerformance.issuedByName||""),issuedById:String(t.currentPerformance.issuedById||""),issuedAt:Math.max(0,Math.floor(l(t.currentPerformance.issuedAt,0))),durationMs:Math.max(1e3,Math.floor(l(t.currentPerformance.durationMs,1e3))),startedAt:Math.max(0,Math.floor(l(t.currentPerformance.startedAt,0))),endsAt:Math.max(0,Math.floor(l(t.currentPerformance.endsAt,0)))}:null,n.queue=Array.isArray(t.queue)?t.queue.map(r=>d(r)?{id:String(r.id||""),commandId:String(r.commandId||""),label:String(r.label||""),categoryTitle:String(r.categoryTitle||""),issuedByName:String(r.issuedByName||""),issuedById:String(r.issuedById||""),issuedAt:Math.max(0,Math.floor(l(r.issuedAt,0))),durationMs:Math.max(1e3,Math.floor(l(r.durationMs,1e3)))}:null).filter(Boolean).slice(0,30):[],n.commandHistory=Array.isArray(t.commandHistory)?t.commandHistory.slice(0,20):[],n.commandCooldowns=d(t.commandCooldowns)?t.commandCooldowns:{},n.overlayFlashAt=Math.max(0,Math.floor(l(t.overlayFlashAt,0))),n.activityFeed=Array.isArray(t.activityFeed)?t.activityFeed.slice(0,30):[],n.savedAt=Math.max(0,Math.floor(l(e.savedAt,Date.now()))),v(),k()},j=e=>{try{sessionStorage.setItem(Y,JSON.stringify(e))}catch{}},ve=()=>{try{const e=sessionStorage.getItem(Y);if(!e)return null;const t=JSON.parse(e);return d(t)?t:null}catch{return null}},ee=async(e,t,o)=>{const r=X();if(!r)return null;const a={};o!==void 0&&(a["content-type"]="application/json");const s=de();s&&(a["x-api-key"]=s);const u=new AbortController,m=setTimeout(()=>u.abort(),ie);try{const i=await fetch(`${r}${t}`,{method:e,headers:a,body:o===void 0?void 0:JSON.stringify(o),credentials:"omit",signal:u.signal});if(i.status===404)return{notFound:!0};if(i.status===409)try{const p=await i.json();return d(p)?{...p,conflict:!0}:{conflict:!0}}catch{return{conflict:!0}}if(!i.ok)throw new Error(`Backend request failed (${i.status})`);return i.status===204?null:await i.json()}finally{clearTimeout(m)}},I=e=>{if(!b())return;const t=O();if(!t)return;const o=`${Q}/${encodeURIComponent(t)}`;G=G.catch(()=>null).then(async()=>{try{const r=await ee("PUT",o,{state:e});if(r!=null&&r.conflict){const a=d(r==null?void 0:r.state)?r.state:await te();Ae(a)&&h()}}catch{}})},M=()=>{n.savedAt=Date.now();const e=R(n.savedAt);j(e),I(e)},te=async()=>{if(!b())return null;const e=O();if(!e)return null;try{const t=`${Q}/${encodeURIComponent(e)}`,o=await ee("GET",t);return!o||o.notFound||!d(o.state)?null:o.state}catch{return null}},Ae=e=>{if(!d(e==null?void 0:e.gameState))return!1;const t=Math.max(0,Math.floor(l(n.savedAt,0)));return $(e)<=t?!1:(D(e),j(e),!0)},Te=async()=>{const e=ve();e&&D(e);const t=await te();if(!t){b()&&I(e||R(Date.now()));return}const o=$(e);if($(t)>=o){D(t),j(t);return}e&&I(e)},ne=()=>{A&&(clearInterval(A),A=null),A=setInterval(()=>{F().then(e=>{e&&(M(),h())})},c.tipMenuRefreshSec*1e3)},we=e=>{const t=(e==null?void 0:e.tokensSpendData)||{};if(t.action!=="director.menu.tip")return;const o=Z(t.userId,t.username);if(!o)return;const r=Math.max(0,Math.floor(g(e.tokensAmount,0)));if(!r)return;const a=String(t.itemId||"").trim(),s=N(a)||ge();if(!s){f(o.id,{type:"director.menu.tip.result",status:"rejected",message:"Сейчас нет доступных позиций tip menu"});return}o.total+=r,o.allocations[s.id]=(o.allocations[s.id]||0)+r,n.totalSessionTips+=r,k({triggerUserId:o.id}),v(),S(`${o.name} +${r} тк в «${s.title}»`),f(o.id,{type:"director.menu.tip.result",status:"accepted",message:`Вклад принят: ${r} тк в «${s.title}»`}),L(o.id),M(),h()},Ie=e=>{const t=Z(e==null?void 0:e.userId,e==null?void 0:e.username);if(!t)return;const o=String((e==null?void 0:e.fromItemId)||"").trim(),r=String((e==null?void 0:e.toItemId)||"").trim(),a=Math.max(0,Math.floor(g(e==null?void 0:e.amount,0)));if(!o||!r||o===r||!a){f(t.id,{type:"director.menu.reallocate.result",status:"rejected",message:"Проверьте from/to и сумму для перераспределения"});return}const s=N(o),u=N(r);if(!s||!u){f(t.id,{type:"director.menu.reallocate.result",status:"rejected",message:"Одна из позиций уже недоступна"});return}const m=Math.max(0,Math.floor(g(t.allocations[o],0)));if(m<a){f(t.id,{type:"director.menu.reallocate.result",status:"rejected",message:`Недостаточно баланса в «${s.title}»`});return}t.allocations[o]=m-a,t.allocations[o]<=0&&delete t.allocations[o],t.allocations[r]=(t.allocations[r]||0)+a,v(),S(`${t.name} перекинул ${a} тк: «${s.title}» → «${u.title}»`),f(t.id,{type:"director.menu.reallocate.result",status:"accepted",message:`Перераспределено ${a} тк`}),L(t.id),M(),h()},be=e=>{const t=String((e==null?void 0:e.userId)||"").trim(),o=String((e==null?void 0:e.username)||"viewer"),r=String((e==null?void 0:e.commandId)||"").trim();if(!t||!r)return;const a=W[r];if(!a){f(t,{type:"director.command.result",status:"rejected",message:"Неизвестная команда"});return}if(!n.isLive){f(t,{type:"director.command.result",status:"rejected",message:"Пульт активируется после выхода в LIVE"});return}if(!n.director.id||n.director.id!==t){f(t,{type:"director.command.result",status:"rejected",message:"Пульт доступен только текущему Режиссёру"});return}const s=Date.now(),u=Math.max(0,Math.floor(g(n.commandCooldowns[r],0)));if(u>s){f(t,{type:"director.command.result",status:"rejected",message:`Команда на кулдауне: ${Math.ceil((u-s)/1e3)}с`});return}const m=c.commandDurationSec*1e3,i={id:`cmd_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,commandId:a.id,label:a.label,categoryTitle:a.categoryTitle,issuedById:t,issuedByName:o,issuedAt:s,durationMs:m};n.currentPerformance?(n.queue.push(i),n.queue=n.queue.slice(0,40)):n.currentPerformance={...i,startedAt:s,endsAt:s+m},n.commandCooldowns[r]=s+c.commandCooldownSec*1e3,n.commandHistory.unshift({id:i.id,commandId:i.commandId,label:i.label,categoryTitle:i.categoryTitle,issuedByName:i.issuedByName,issuedAt:i.issuedAt}),n.commandHistory=n.commandHistory.slice(0,25),n.overlayFlashAt=s,S(`Команда режиссёра: ${a.label}`),C(`Режиссёр: ${a.categoryTitle} / ${a.label}`),f(t,{type:"director.command.result",status:"accepted",message:`Команда «${a.label}» отправлена`,commandId:r,cooldownMs:c.commandCooldownSec*1e3}),M(),h()},ke=()=>{const e=Date.now();let t=!1;if(n.currentPerformance&&e>=n.currentPerformance.endsAt){if(n.queue.length>0){const r=n.queue.shift(),a=Math.max(1e3,Math.floor(g(r.durationMs,c.commandDurationSec*1e3)));n.currentPerformance={...r,startedAt:e,endsAt:e+a},S(`В эфире: ${r.label}`)}else n.currentPerformance=null,S("Текущая команда завершена");t=!0}const o=Object.keys(n.commandCooldowns);o.forEach(r=>{const a=Math.max(0,Math.floor(g(n.commandCooldowns[r],0)));(!a||a<=e)&&(delete n.commandCooldowns[r],t=!0)}),t&&M(),(n.isLive||n.currentPerformance||o.length>0)&&h()},xe=()=>{U||(U=setInterval(ke,ue))},re=()=>{T&&(clearInterval(T),T=null),T=setInterval(()=>{if(!b())return;const e=Math.max(0,Math.floor(l(n.savedAt,0))),t=R(e||Date.now());I(t)},ce)},Be=()=>{H||(H=setInterval(()=>{h()},le))},oe=async()=>{const{settings:e}=await y.makeRequest("v1.model.ext.settings.get",null);c=J(e||V)},Ee=async()=>{try{await oe(),ne(),re(),k(),await F(),M(),h()}catch{}},$e=e=>{if(d(e)){if(e.type==="director.state.request"){h();return}if(e.type==="director.self.allocations.request"){L(e.userId);return}if(e.type==="director.menu.reallocate"){Ie(e);return}if(e.type==="director.command.issue"){be(e);return}e.type==="director.settings.updated"&&Ee()}},Ce=async()=>{q=await y.makeRequest("v1.ext.context.get",null),await oe(),await Te(),n.tipMenu.settings.length?v():await F(),k(),y.subscribe("v1.ext.whispered",$e),y.subscribe("v1.payment.tokens.spend.succeeded",we),Se(),xe(),ne(),re(),Be(),M(),h()};Ce();
